name: Generate Secure SLSA Provenance

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Name of the container image to attest (e.g., myregistry/nginx:1.25)'
        required: true
        default: 'nginx:1.25' # Use the image from your request as a default

jobs:
  generate-provenance:
    # Use the official SLSA builder to secure the execution environment
    permissions:
      id-token: write # Required for keyless signing with Sigstore
      packages: write # Required to upload the container image
      contents: read # Required to checkout the repo
    
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v1.9.0 # Use the latest stable version
    with:
      # Pass the image name from the workflow dispatch input
      image: ${{ github.event.inputs.image_name }}
      digest: 'sha256:a484819eb60211f5299034ac80f6a681b06f89e65866ce91f356ed7c72af059c'
      registry-username: ${{ github.actor }}
      
      # NOTE: For a real build, you would need to specify a digest.
      # Since you want to simulate running the generator tool, we'll use the tag.
      # The generator_container_slsa3.yml typically expects an image to be built 
      # and pushed *within* the workflow or specified by digest.
      # For a simpler attestation of a *pre-existing* image, the generator tool 
      # can be used, but the reusable workflow is the most secure method for *building* and attesting.

    # This job runs *after* the slsa-framework job is complete
    # The SLSA generator will have already uploaded the attestation as a signed artifact.
    # We will simply download that signed artifact and re-upload it with a different name.

  # This optional job helps make the final artifact easier to find
  # by renaming and re-uploading the artifact created by the SLSA generator.
  upload-final-artifact:
    needs: [generate-provenance]
    runs-on: ubuntu-latest
    steps:
      - name: Download SLSA Attestation Artifact
        uses: actions/download-artifact@v4
        with:
          # The slsa-github-generator names its artifacts with a specific format
          name: attestations
          path: attestation_download

      - name: Find and Upload Final Attestation File
        id: final_upload
        run: |
          # The downloaded artifact will be in a folder structure. 
          # We search for the *.intoto.jsonl file created by the generator.
          ATTESTATION_FILE=$(find attestation_download -name "*.intoto.jsonl" -print -quit)
          
          if [ -z "$ATTESTATION_FILE" ]; then
            echo "::error::SLSA Attestation file not found."
            exit 1
          fi

          echo "Found attestation file: $ATTESTATION_FILE"
          echo "attestation_path=$ATTESTATION_FILE" >> $GITHUB_OUTPUT

      - name: Upload Renamed Attestation as Artifact
        uses: actions/upload-artifact@v4
        with:
          # Give the artifact a clear, custom name for easy download
          name: nginx-provenance-slsa3
          path: ${{ steps.final_upload.outputs.attestation_path }}
          retention-days: 7
